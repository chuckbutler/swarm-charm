---
- hosts: all
  handlers:
    - name: open management port
      command: open-port 2376
    - name: join cluster
      docker:
        command="{{join_command}}"
        image=swarm
        state=reloaded
        restart_policy=always
        detach=true
        name="swarm-node"
        ports={{unit_private_address}}:2375:2375
    - name: manage cluster
      docker:
        command="{{manage_command}}"
        image=swarm
        state=reloaded
        restart_policy=always
        detach=true
        ports={{unit_public_address}}:5001:2375
        name="swarm-manage"
  tasks:
    - debug: msg="wat"
      tags:
        - config-changed
        - upgrade-charm

    - include: config-changed.yml
      tags:
        - config-changed

    - include: upgrade-charm.yml
      tags:
        - upgrade-charm

    - include: docker-cluster.yml
      tags:
        - docker-cluster-relation-changed

    - include: register.yml
      tags:
        - register-relation-changed

    - include: etcd.yml
      tags:
        - etcd-relation-changed
